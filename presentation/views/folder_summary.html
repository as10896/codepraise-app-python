{% extends "layout.html" %}
{% block content %}
<div class="container">
  {% if result.processing %}
  <div class="row justify-content-center">
    <div class="col-12 col-md-10 col-lg-9 col-xl-7 col-xxl-6">
      <div class="progress">
        <div
          class="progress-bar progress-bar-success active"
          role="progressbar"
          aria-valuenow="10"
          aria-valuemin="0"
          aria-valuemax="100"
          style="width: 0%"
        ></div>
      </div>
    </div>
  </div>
  <script>
    const wsHost = "{{ processing.ws_host }}"
    const channelId = "{{ processing.ws_channel_id }}"
    const ws = new WebSocket(`${wsHost}/progress/${channelId}`)
    const bar = document.getElementsByClassName("progress-bar")[0]
    const reg = /\: (\d+)%/

    ws.onmessage = function(event) {
      // Collect progressbar element and percentage
      const progress = bar.getAttribute("style")
      const currentProgress = reg.exec(progress)[1]  // problematic

      const message = event.data
      if (isNaN(message)) {
        bar.setAttribute("style", "width: 100%")
        bar.setAttribute("class", "progress-bar progress-bar-danger progress-bar-striped")
        bar.innerHTML = message
      } else {
        if (parseInt(message) > parseInt(currentProgress)) {
          // Set the progress bar and percentage
          bar.setAttribute("aria-valuenow", message)
          bar.setAttribute("style", `width: ${message}%`)
          bar.innerHTML = `${message}%`

          // Reoad page at 100%
          if (message == "100") {
            setTimeout(function () {
              window.location = window.location.href.split('?')[0]
            }, 1000)
          }
        }
      }
    }
  </script>
  {% else %}

  <nav aria-label="breadcrumb">
    <i class="mdi mdi-folder-open-outline" aria-hidden="true"></i>
    <ol class="breadcrumb d-inline">
      {% set breadcrumb_items, current_dir = folder.breadcrumb %}
      {% for breadcrumb_item in breadcrumb_items %}
      <li class="breadcrumb-item d-inline-block"><a href="{{ breadcrumb_item[1] }}">{{ breadcrumb_item[0] }}</a></li>
      {% endfor %}
      <li class="breadcrumb-item active d-inline-block" aria-current="page">{{ current_dir }}</li>
    </ol>
  </nav>
    
  <div class="row justify-content-center">
    <table class="table" id="repos_table">
      <thead>
        <tr>
          <th>
            {% for contributor in folder.contributors %}
            <th>{{ contributor.name }}</th>
            {% endfor %}
          </th>
        </tr>
      </thead>
      <tbody>
        {% for sub in folder.subfolders %}
        <tr>
          <td>
            <a href="{{ sub.link }}">
              <span>{{ sub.name }}/</span>
            </a>
          </td>
          {% for contributor in folder.contributors %}
          <td>
            <span>{{ sub.contributions[contributor] }}</span>
          </td>
          {% endfor %}
        </tr>
        <tr>
          {% for _ in range(folder.contributors | length + 1) %}
          <td></td>
          {% endfor %}
        </tr>
        {% endfor %}

        <tr>
          <td>
            <span>
              files
            </span>
          </td>
          {% for contributor in folder.contributors %}
          <td>
            <span>
              {{ folder.base_folder.contributions[contributor] }}
            </span>
          </td>
          {% endfor %}
        </tr>

        {% for sub in folder.base_files %}
        <tr>
          <td>
            <span>
              {{ sub.name }}
            </span>
          </td>
          {% for contributor in folder.contributors %}
          <td>
            <span>
              {{ sub.contributions[contributor] }}
            </span>
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>
{% endblock %}